"use strict";var __awaiter=this&&this.__awaiter||function(e,t,s,a){return new(s||(s=Promise))(function(n,l){function i(e){try{o(a.next(e))}catch(e){l(e)}}function r(e){try{o(a.throw(e))}catch(e){l(e)}}function o(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(i,r)}o((a=a.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{var e,t;const s=exports.Emile,a=exports.parserClasses;let n=exports.pendingFiles;function l(e){e.preventDefault(),cityssm.postJSON(s.urlPrefix+"/data/doUpdatePendingEnergyDataFile",e.currentTarget,e=>{var t,s;const a=e;a.success?(bulmaJS.alert({message:"File Updated Successfully",contextualColorName:"success"}),n=null!==(t=a.pendingFiles)&&void 0!==t?t:[],d()):bulmaJS.alert({title:"Error Updating File",message:null!==(s=a.errorMessage)&&void 0!==s?s:"Please try again.",contextualColorName:"danger"})})}function i(e){var t,i;const r=Number.parseInt(null!==(i=null===(t=e.currentTarget.closest("tr"))||void 0===t?void 0:t.dataset.fileId)&&void 0!==i?i:"",10),o=n.find(e=>e.fileId===r);cityssm.openHtmlModal("data-parserSettings",{onshow(e){var t,s,n,l,i,r,d;e.querySelector("#energyDataFileEdit--fileId").value=null!==(s=null===(t=o.fileId)||void 0===t?void 0:t.toString())&&void 0!==s?s:"",e.querySelector('[data-field="originalFileName"]').textContent=o.originalFileName,null!==o.assetId&&(e.querySelector("#energyDataFileEdit--assetId").value=null!==(l=null===(n=o.assetId)||void 0===n?void 0:n.toString())&&void 0!==l?l:"",e.querySelector("#energyDataFileEdit--assetSelector .icon").innerHTML=`<i class="${null!==(i=o.fontAwesomeIconClasses)&&void 0!==i?i:"fas fa-bolt"}" aria-hidden="true"></i>`,e.querySelector("#energyDataFileEdit--assetSelector button").textContent=null!==(r=o.assetName)&&void 0!==r?r:"");const c=e.querySelector("#energyDataFileEdit--parserClass");let u=!1;for(const e of a){const t=document.createElement("option");t.value=e,t.textContent=e,e===(null===(d=o.parserProperties)||void 0===d?void 0:d.parserClass)&&(t.selected=!0,u=!0),c.append(t)}if(!u&&void 0!==o.parserProperties&&void 0!==o.parserProperties.parserClass){const e=document.createElement("option");e.value=o.parserProperties.parserClass,e.textContent=o.parserProperties.parserClass,e.selected=!0,c.append(e)}},onshown(e){var t;bulmaJS.toggleHtmlClipped(),s.initializeAssetSelector({assetSelectorElement:e.querySelector("#energyDataFileEdit--assetSelector")}),null===(t=e.querySelector("form"))||void 0===t||t.addEventListener("submit",l)},onremoved(){bulmaJS.toggleHtmlClipped()}})}function r(e){var t,a;const l=Number.parseInt(null!==(a=null===(t=e.currentTarget.closest("tr"))||void 0===t?void 0:t.dataset.fileId)&&void 0!==a?a:"",10);bulmaJS.confirm({title:"Delete File",message:"Are you sure you want to delete this file?",contextualColorName:"warning",okButton:{text:"Yes, Delete File",callbackFunction:function(){cityssm.postJSON(s.urlPrefix+"/data/doDeletePendingEnergyDataFile",{fileId:l},e=>{var t;const s=e;s.success?(bulmaJS.alert({message:"File Deleted Successfully",contextualColorName:"success"}),n=s.pendingFiles,d()):bulmaJS.alert({title:"Error Deleting File",message:null!==(t=s.errorMessage)&&void 0!==t?t:"Please try again.",contextualColorName:"danger"})})}}})}function o(e){var t,a;const l=Number.parseInt(null!==(a=null===(t=e.currentTarget.closest("tr"))||void 0===t?void 0:t.dataset.fileId)&&void 0!==a?a:"",10);bulmaJS.confirm({title:"Mark File Ready to Process",message:"Are you sure you are ready for this file to be processed?",contextualColorName:"info",okButton:{text:"Yes, Process File",callbackFunction:function(){cityssm.postJSON(s.urlPrefix+"/data/doProcessPendingEnergyDataFile",{fileId:l},e=>{var t;const s=e;s.success?(bulmaJS.alert({title:"File Marked for Processing Successfully",message:"Processing may take a few minutes depending on how many files are being processed.",contextualColorName:"success"}),n=s.pendingFiles,d()):bulmaJS.alert({title:"Error Updating File",message:null!==(t=s.errorMessage)&&void 0!==t?t:"Please try again.",contextualColorName:"danger"})})}}})}function d(){var e,t,s,a,l,d,c,u,p,f,g,m,v;const y=document.querySelector("#count--pendingFiles"),b=document.querySelector("#container--pendingFiles");if(y.textContent=n.length.toString(),0===n.length)return void(b.innerHTML='<div class="message is-info">\n        <p class="message-body">There are no pending files that require attention.</p>\n        </div>');const h=document.createElement("table");h.className="table is-fullwidth is-striped is-hoverable has-sticky-header",h.innerHTML='<thead><tr>\n      <th>Pending File</th>\n      <th>Parser Settings</th>\n      <th><span class="is-sr-only">Options</span></th>\n      </tr></thead>\n      <tbody></tbody>';for(const y of n){const n=document.createElement("tr");n.dataset.fileId=null===(e=y.fileId)||void 0===e?void 0:e.toString();const b=new Date(y.recordCreate_timeMillis);n.innerHTML=`<td>\n          <span class="has-text-weight-bold" data-field="originalFileName"></span><br />\n          <span class="is-size-7">Uploaded ${b.toISOString()}</span>\n        </td>\n        <td class="is-size-7">\n          <span>${null===y.assetId?'<i class="fas fa-fw fa-hat-wizard" aria-hidden="true"></i> Detect Asset from File':`<i class="fa-fw ${null!==(t=y.fontAwesomeIconClasses)&&void 0!==t?t:"fas fa-bolt"}" aria-hidden="true"></i> <span data-field="assetName"></span>`}</span><br />\n          <span>\n            <i class="fas fa-fw fa-cog" aria-hidden="true"></i>\n            ${""===(null!==(a=null===(s=y.parserProperties)||void 0===s?void 0:s.parserClass)&&void 0!==a?a:"")?"No Parser Selected":null!==(d=null===(l=y.parserProperties)||void 0===l?void 0:l.parserClass)&&void 0!==d?d:""}\n          </span>\n        </td>\n        <td class="has-text-right">\n          <button class="button is-info is-settings-button" type="button">\n            <span class="icon"><i class="fas fa-pencil-alt" aria-hidden="true"></i></span>\n            <span>Settings</span>\n          </button>\n          <button class="button is-success is-parse-button" type="button" ${""===(null!==(u=null===(c=y.parserProperties)||void 0===c?void 0:c.parserClass)&&void 0!==u?u:"")?"disabled":""}>\n            <span class="icon"><i class="fas fa-cogs" aria-hidden="true"></i></span>\n            <span>Parse File</span>\n          </button>\n          <button class="button is-danger is-light is-delete-button" type="button" aria-label="Delete File">\n            <i class="fas fa-trash" aria-hidden="true"></i>\n          </button>\n        </td>`,null!==y.assetId&&(n.querySelector('[data-field="assetName"]').textContent=null!==(p=y.assetName)&&void 0!==p?p:""),n.querySelector('[data-field="originalFileName"]').textContent=y.originalFileName,null===(f=n.querySelector(".is-settings-button"))||void 0===f||f.addEventListener("click",i),null===(g=n.querySelector(".is-parse-button"))||void 0===g||g.addEventListener("click",o),null===(m=n.querySelector(".is-delete-button"))||void 0===m||m.addEventListener("click",r),null===(v=h.querySelector("tbody"))||void 0===v||v.append(n)}b.innerHTML="",b.append(h)}delete exports.pendingFiles,d();let c=exports.processedFiles;function u(e){var t,a;const l=Number.parseInt(null!==(a=null===(t=e.currentTarget.closest("tr"))||void 0===t?void 0:t.dataset.fileId)&&void 0!==a?a:"",10);bulmaJS.confirm({title:"Mark File for Reprocessing",message:"Are you sure you want to reprocess this file?",contextualColorName:"info",okButton:{text:"Yes, Reprocess File",callbackFunction:function(){cityssm.postJSON(s.urlPrefix+"/data/doReprocessProcessedEnergyDataFile",{fileId:l},e=>{var t,s;const a=e;a.success?(bulmaJS.alert({title:"File Marked Moved to Pending List",message:"All data associated with the file has been deleted. You can now change any necessary processing settings, and process the file again.",contextualColorName:"success"}),n=null!==(t=a.pendingFiles)&&void 0!==t?t:[],d(),c=a.processedFiles,f()):bulmaJS.alert({title:"Error Updating File",message:null!==(s=a.errorMessage)&&void 0!==s?s:"Please try again.",contextualColorName:"danger"})})}}})}function p(e){var t,a;const n=Number.parseInt(null!==(a=null===(t=e.currentTarget.closest("tr"))||void 0===t?void 0:t.dataset.fileId)&&void 0!==a?a:"",10);bulmaJS.confirm({title:"Delete File",message:"Are you sure you want to delete this file?",contextualColorName:"warning",okButton:{text:"Yes, Delete File",callbackFunction:function(){cityssm.postJSON(s.urlPrefix+"/data/doDeleteProcessedEnergyDataFile",{fileId:n},e=>{var t;const s=e;s.success?(bulmaJS.alert({message:"File Deleted Successfully",contextualColorName:"success"}),c=s.processedFiles,f()):bulmaJS.alert({title:"Error Deleting File",message:null!==(t=s.errorMessage)&&void 0!==t?t:"Please try again.",contextualColorName:"danger"})})}}})}function f(){var e,t,s,a,n,l;const i=document.querySelector("#container--processedFiles"),r=document.createElement("table");r.className="table is-fullwidth is-striped is-hoverable has-sticky-header",r.innerHTML='<thead><tr>\n      <th class="has-width-10"><span class="is-sr-only">Processed Status</span></th>\n      <th>Processed File</th>\n      <th>Results</th>\n      <th><span class="is-sr-only">Options</span></th>\n      </tr></thead>\n      <tbody></tbody>';for(const i of c){const o=document.createElement("tr");o.dataset.fileId=null===(e=i.fileId)||void 0===e?void 0:e.toString(),o.innerHTML=`<td>\n        ${i.isFailed?'<i class="fas fa-exclamation-circle has-text-danger" aria-hidden="true"></i>':'<i class="fas fa-check-circle has-text-success" aria-hidden="true"></i>'}\n        </td>\n        <td><strong data-field="originalFileName"></strong></td>\n        <td data-field="results"></td>\n        <td class="has-text-right">\n          <button class="button is-warning is-reprocess-button" type="button">\n            <span class="icon"><i class="fas fa-cogs" aria-hidden="true"></i></span>\n            <span>Process Again</span>\n          </button>\n          ${i.isFailed?'<button class="button is-light is-danger is-delete-button" type="button">\n                  <i class="fas fa-trash" aria-hidden="true"></i>\n                  </button>':""}\n        </td>`,o.querySelector('[data-field="originalFileName"]').textContent=i.originalFileName,o.querySelector('[data-field="results"]').textContent=i.isFailed?null!==(t=i.processedMessage)&&void 0!==t?t:"":`${null!==(s=i.energyDataCount)&&void 0!==s?s:0} data points`,null===(a=o.querySelector(".is-reprocess-button"))||void 0===a||a.addEventListener("click",u),null===(n=o.querySelector(".is-delete-button"))||void 0===n||n.addEventListener("click",p),null===(l=r.querySelector("tbody"))||void 0===l||l.append(o)}0===c.length?i.innerHTML='<div class="message is-info">\n        <p class="message-body">There are no processed files to display.</p>\n        </div>':(i.innerHTML="",i.append(r))}delete exports.processedFiles,f();const g=null!==(t=null===(e=document.querySelector("meta[name='csrf-token']"))||void 0===e?void 0:e.getAttribute("content"))&&void 0!==t?t:"",m=document.querySelector("#upload--dropZone"),v=["has-background-success-light","has-text-success"];m.addEventListener("dragover",e=>{e.preventDefault(),m.classList.add(...v)}),m.addEventListener("dragleave",e=>{e.preventDefault(),m.classList.remove(...v)}),m.addEventListener("drop",e=>{var t,a;e.preventDefault();const l=new FormData;if(void 0!==(null===(t=e.dataTransfer)||void 0===t?void 0:t.items)){for(const t of e.dataTransfer.items)if("file"===t.kind){const e=t.getAsFile();l.append("file",e)}}else if(void 0!==(null===(a=e.dataTransfer)||void 0===a?void 0:a.files))for(const t of e.dataTransfer.files)l.append("file",t);fetch(s.urlPrefix+"/data/doUploadDataFiles",{credentials:"same-origin",headers:{"CSRF-Token":g},method:"POST",body:l}).then(e=>__awaiter(void 0,void 0,void 0,function*(){return yield e.json()})).then(e=>{var t;return e.success&&(n=e.pendingFiles,d(),c=null!==(t=e.processedFiles)&&void 0!==t?t:[],f()),e.success}).catch(()=>{bulmaJS.alert({message:"Error processing files.",contextualColorName:"danger"})}),m.classList.remove(...v)}),bulmaJS.init()})();