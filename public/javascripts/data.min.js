"use strict";var __awaiter=this&&this.__awaiter||function(e,t,s,n){return new(s||(s=Promise))(function(a,i){function l(e){try{r(n.next(e))}catch(e){i(e)}}function o(e){try{r(n.throw(e))}catch(e){i(e)}}function r(e){var t;e.done?a(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(l,o)}r((n=n.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{var e,t,s;const n=exports.Emile,a=exports.parserClassesAndConfigurations;let i=exports.pendingFiles;function l(e){e.preventDefault(),cityssm.postJSON(`${n.urlPrefix}/data/doUpdatePendingEnergyDataFile`,e.currentTarget,e=>{var t,s;const n=e;n.success?(bulmaJS.alert({message:"File Updated Successfully",contextualColorName:"success"}),i=null!==(t=n.pendingFiles)&&void 0!==t?t:[],c()):bulmaJS.alert({title:"Error Updating File",message:null!==(s=n.errorMessage)&&void 0!==s?s:"Please try again.",contextualColorName:"danger"})})}function o(e){var t,s;const o=Number.parseInt(null!==(s=null===(t=e.currentTarget.closest("tr"))||void 0===t?void 0:t.dataset.fileId)&&void 0!==s?s:"",10),r=i.find(e=>e.fileId===o);cityssm.openHtmlModal("data-parserSettings",{onshow(e){var t,s,n,i,l,o,d,c,u;e.querySelector("#energyDataFileEdit--fileId").value=null!==(s=null===(t=r.fileId)||void 0===t?void 0:t.toString())&&void 0!==s?s:"",e.querySelector('[data-field="originalFileName"]').textContent=r.originalFileName,null!==r.assetId&&(e.querySelector("#energyDataFileEdit--assetId").value=null!==(i=null===(n=r.assetId)||void 0===n?void 0:n.toString())&&void 0!==i?i:"",e.querySelector("#energyDataFileEdit--assetSelector .icon").innerHTML=`<i class="${null!==(l=r.fontAwesomeIconClasses)&&void 0!==l?l:"fas fa-bolt"}" aria-hidden="true"></i>`,e.querySelector("#energyDataFileEdit--assetSelector button").textContent=null!==(o=r.assetName)&&void 0!==o?o:"");const p=e.querySelector("#energyDataFileEdit--parserClass");let f=!1;const g=(null!==(c=null===(d=r.parserProperties)||void 0===d?void 0:d.parserClass)&&void 0!==c?c:"")+(void 0===(null===(u=r.parserProperties)||void 0===u?void 0:u.parserConfig)?"":`::${r.parserProperties.parserConfig}`);for(const e of a){const t=document.createElement("option");t.value=e,t.textContent=e,e===g&&(t.selected=!0,f=!0),p.append(t)}if(!f&&void 0!==r.parserProperties&&void 0!==r.parserProperties.parserClass){const e=document.createElement("option");e.value=g,e.textContent=`${g} (Unavailable)`,e.selected=!0,p.append(e)}},onshown(e){var t;bulmaJS.toggleHtmlClipped(),n.initializeAssetSelector({assetSelectorElement:e.querySelector("#energyDataFileEdit--assetSelector")}),null===(t=e.querySelector("form"))||void 0===t||t.addEventListener("submit",l)},onremoved(){bulmaJS.toggleHtmlClipped()}})}function r(e){var t,s;const a=Number.parseInt(null!==(s=null===(t=e.currentTarget.closest("tr"))||void 0===t?void 0:t.dataset.fileId)&&void 0!==s?s:"",10);bulmaJS.confirm({title:"Delete File",message:"Are you sure you want to delete this file?",contextualColorName:"warning",okButton:{text:"Yes, Delete File",callbackFunction:function(){cityssm.postJSON(`${n.urlPrefix}/data/doDeletePendingEnergyDataFile`,{fileId:a},e=>{var t;const s=e;s.success?(bulmaJS.alert({message:"File Deleted Successfully",contextualColorName:"success"}),i=s.pendingFiles,c()):bulmaJS.alert({title:"Error Deleting File",message:null!==(t=s.errorMessage)&&void 0!==t?t:"Please try again.",contextualColorName:"danger"})})}}})}function d(e){var t,s;const a=Number.parseInt(null!==(s=null===(t=e.currentTarget.closest("tr"))||void 0===t?void 0:t.dataset.fileId)&&void 0!==s?s:"",10);bulmaJS.confirm({title:"Mark File Ready to Process",message:"Are you sure you are ready for this file to be processed?",contextualColorName:"info",okButton:{text:"Yes, Process File",callbackFunction:function(){cityssm.postJSON(`${n.urlPrefix}/data/doProcessPendingEnergyDataFile`,{fileId:a},e=>{var t;const s=e;s.success?(bulmaJS.alert({title:"File Marked for Processing Successfully",message:"Processing may take a few minutes depending on how many files are being processed.",contextualColorName:"success"}),i=s.pendingFiles,c()):bulmaJS.alert({title:"Error Updating File",message:null!==(t=s.errorMessage)&&void 0!==t?t:"Please try again.",contextualColorName:"danger"})})}}})}function c(){var e,t,s,n,a,l,c,u,p,f,g,v,m,h,b,y,S;const F=document.querySelector("#count--pendingFiles"),x=document.querySelector("#container--pendingFiles");if(F.textContent=i.length.toString(),0===i.length)return void(x.innerHTML='<div class="message is-info">\n        <p class="message-body">There are no pending files that require attention.</p>\n        </div>');const P=document.createElement("table");P.className="table is-fullwidth is-striped is-hoverable has-sticky-header",P.innerHTML='<thead><tr>\n      <th>Pending File</th>\n      <th>Parser Settings</th>\n      <th><span class="is-sr-only">Options</span></th>\n      </tr></thead>\n      <tbody></tbody>';for(const F of i){const i=document.createElement("tr");i.dataset.fileId=null===(e=F.fileId)||void 0===e?void 0:e.toString();const x=new Date(F.recordCreate_timeMillis);i.innerHTML=`<td>\n          <span class="has-text-weight-bold" data-field="originalFileName"></span><br />\n          <span class="is-size-7">Uploaded ${x.toISOString()}</span>\n        </td>\n        <td class="is-size-7">\n          <span>${null===F.assetId?'<i class="fas fa-fw fa-hat-wizard" aria-hidden="true"></i> Detect Asset from File':`<i class="fa-fw ${null!==(t=F.fontAwesomeIconClasses)&&void 0!==t?t:"fas fa-bolt"}" aria-hidden="true"></i> <span data-field="assetName"></span>`}</span><br />\n          <span>\n            <i class="fas fa-fw fa-book-open" aria-hidden="true"></i>\n            ${""===(null!==(n=null===(s=F.parserProperties)||void 0===s?void 0:s.parserClass)&&void 0!==n?n:"")?"No Parser Selected":null!==(l=null===(a=F.parserProperties)||void 0===a?void 0:a.parserClass)&&void 0!==l?l:""}\n          </span><br />\n          ${""===(null!==(u=null===(c=F.parserProperties)||void 0===c?void 0:c.parserConfig)&&void 0!==u?u:"")?"":`<span>\n                <i class="fas fa-fw fa-cog" aria-hidden="true"></i>\n                ${null!==(f=null===(p=F.parserProperties)||void 0===p?void 0:p.parserConfig)&&void 0!==f?f:""}\n              </span>`}\n        </td>\n        <td class="has-text-right">\n          <button class="button is-info is-settings-button" type="button">\n            <span class="icon"><i class="fas fa-pencil-alt" aria-hidden="true"></i></span>\n            <span>Settings</span>\n          </button>\n          <button class="button is-success is-parse-button" type="button" ${""===(null!==(v=null===(g=F.parserProperties)||void 0===g?void 0:g.parserClass)&&void 0!==v?v:"")?"disabled":""}>\n            <span class="icon"><i class="fas fa-cogs" aria-hidden="true"></i></span>\n            <span>Parse File</span>\n          </button>\n          <button class="button is-danger is-light is-delete-button" type="button" aria-label="Delete File">\n            <i class="fas fa-trash" aria-hidden="true"></i>\n          </button>\n        </td>`,null!==F.assetId&&(i.querySelector('[data-field="assetName"]').textContent=null!==(m=F.assetName)&&void 0!==m?m:""),i.querySelector('[data-field="originalFileName"]').textContent=F.originalFileName,null===(h=i.querySelector(".is-settings-button"))||void 0===h||h.addEventListener("click",o),null===(b=i.querySelector(".is-parse-button"))||void 0===b||b.addEventListener("click",d),null===(y=i.querySelector(".is-delete-button"))||void 0===y||y.addEventListener("click",r),null===(S=P.querySelector("tbody"))||void 0===S||S.append(i)}x.innerHTML="",x.append(P)}delete exports.pendingFiles,null===(e=document.querySelector(".is-refresh-button"))||void 0===e||e.addEventListener("click",()=>{cityssm.postJSON(`${n.urlPrefix}/data/doGetPendingFiles`,{},e=>{var t;const s=e;s.success&&(i=s.pendingFiles,c(),u=null!==(t=s.processedFiles)&&void 0!==t?t:[],g())})}),c();let u=exports.processedFiles;function p(e){var t,s;const a=Number.parseInt(null!==(s=null===(t=e.currentTarget.closest("tr"))||void 0===t?void 0:t.dataset.fileId)&&void 0!==s?s:"",10);bulmaJS.confirm({title:"Mark File for Reprocessing",message:"Are you sure you want to reprocess this file?",contextualColorName:"info",okButton:{text:"Yes, Reprocess File",callbackFunction:function(){cityssm.postJSON(`${n.urlPrefix}/data/doReprocessProcessedEnergyDataFile`,{fileId:a},e=>{var t,s;const n=e;n.success?(bulmaJS.alert({title:"File Marked Moved to Pending List",message:"All data associated with the file has been deleted.\n                  You can now change any necessary processing settings, and process the file again.",contextualColorName:"success"}),i=null!==(t=n.pendingFiles)&&void 0!==t?t:[],c(),u=n.processedFiles,g()):bulmaJS.alert({title:"Error Updating File",message:null!==(s=n.errorMessage)&&void 0!==s?s:"Please try again.",contextualColorName:"danger"})})}}})}function f(e){var t,s;const a=Number.parseInt(null!==(s=null===(t=e.currentTarget.closest("tr"))||void 0===t?void 0:t.dataset.fileId)&&void 0!==s?s:"",10);bulmaJS.confirm({title:"Delete File",message:"Are you sure you want to delete this file?",contextualColorName:"warning",okButton:{text:"Yes, Delete File",callbackFunction:function(){cityssm.postJSON(`${n.urlPrefix}/data/doDeleteProcessedEnergyDataFile`,{fileId:a},e=>{var t;const s=e;s.success?(bulmaJS.alert({message:"File Deleted Successfully",contextualColorName:"success"}),u=s.processedFiles,g()):bulmaJS.alert({title:"Error Deleting File",message:null!==(t=s.errorMessage)&&void 0!==t?t:"Please try again.",contextualColorName:"danger"})})}}})}function g(){var e,t,s,a,i,l,o,r,d;const c=document.querySelector("#container--processedFiles"),g=document.createElement("table");g.className="table is-fullwidth is-striped is-hoverable has-sticky-header",g.innerHTML='<thead><tr>\n      <th class="has-width-10"><span class="is-sr-only">Processed Status</span></th>\n      <th>Processed File</th>\n      <th>From</th>\n      <th>To</th>\n      <th class="has-text-right">Data Points</th>\n      <th class="has-text-right">Assets</th>\n      <th><span class="is-sr-only">Options</span></th>\n      </tr></thead>\n      <tbody></tbody>';for(const c of u){const u=document.createElement("tr");u.dataset.fileId=null===(e=c.fileId)||void 0===e?void 0:e.toString(),u.innerHTML=`<td>\n        ${c.isFailed?'<i class="fas fa-exclamation-circle has-text-danger" aria-hidden="true"></i>':'<i class="fas fa-check-circle has-text-success" aria-hidden="true"></i>'}\n        </td>\n        <td><strong data-field="originalFileName"></strong></td>\n        ${c.isFailed?'<td data-field="processedMessage" colspan="4"></td>':`<td>${new Date(1e3*(null!==(t=c.timeSecondsMin)&&void 0!==t?t:0)).toLocaleString()}</td>\n              <td>${new Date(1e3*(null!==(s=c.endTimeSecondsMax)&&void 0!==s?s:0)).toLocaleString()}</td>\n              <td class="has-text-right">\n                ${null!==(a=c.energyDataCount)&&void 0!==a?a:0}\n              </td>\n              <td class="has-text-right">\n                ${null!==(i=c.assetIdCount)&&void 0!==i?i:0}\n              </td>`}\n        \n        <td class="has-text-right">\n          ${c.isFailed?'<button class="button is-light is-danger is-delete-button" type="button">\n                  <i class="fas fa-trash" aria-hidden="true"></i>\n                  </button>':`<a class="button" href="${n.urlPrefix}/reports/energyData-formatted-filtered?fileId=${c.fileId}" type="download">\n                  <span class="icon is-small"><i class="fas fa-file-csv" aria-hidden="true"></i></span>\n                  <span>Export</span>\n                </a>`}\n          <button class="button is-warning is-reprocess-button" type="button">\n            <span class="icon"><i class="fas fa-cogs" aria-hidden="true"></i></span>\n            <span>Process Again</span>\n          </button>\n        </td>`,u.querySelector('[data-field="originalFileName"]').textContent=c.originalFileName,c.isFailed&&(u.querySelector('[data-field="processedMessage"]').textContent=null!==(l=c.processedMessage)&&void 0!==l?l:""),null===(o=u.querySelector(".is-reprocess-button"))||void 0===o||o.addEventListener("click",p),null===(r=u.querySelector(".is-delete-button"))||void 0===r||r.addEventListener("click",f),null===(d=g.querySelector("tbody"))||void 0===d||d.append(u)}0===u.length?c.innerHTML='<div class="message is-info">\n        <p class="message-body">There are no processed files to display.</p>\n        </div>':(c.innerHTML="",c.append(g))}delete exports.processedFiles,g();const v=null!==(s=null===(t=document.querySelector("meta[name='csrf-token']"))||void 0===t?void 0:t.getAttribute("content"))&&void 0!==s?s:"",m=document.querySelector("#upload--dropZone"),h=["has-background-success-light","has-text-success"];m.addEventListener("dragover",e=>{e.preventDefault(),m.classList.add(...h)}),m.addEventListener("dragleave",e=>{e.preventDefault(),m.classList.remove(...h)}),m.addEventListener("drop",e=>{var t,s;e.preventDefault();const a=new FormData;if(void 0!==(null===(t=e.dataTransfer)||void 0===t?void 0:t.items)){for(const t of e.dataTransfer.items)if("file"===t.kind){const e=t.getAsFile();a.append("file",e)}}else if(void 0!==(null===(s=e.dataTransfer)||void 0===s?void 0:s.files))for(const t of e.dataTransfer.files)a.append("file",t);fetch(`${n.urlPrefix}/data/doUploadDataFiles`,{credentials:"same-origin",headers:{"CSRF-Token":v},method:"POST",body:a}).then(e=>__awaiter(void 0,void 0,void 0,function*(){return yield e.json()})).then(e=>{var t;return e.success&&(i=e.pendingFiles,c(),u=null!==(t=e.processedFiles)&&void 0!==t?t:[],g(),document.querySelector("#container--pendingFiles").insertAdjacentHTML("afterbegin",'<div class="message is-info">\n                <p class="message-body">\n                  <strong>Refresh the list below to see the newly uploaded files.</strong><br />\n                  If the files don\'t appear in the list, switch to the Processed Files tab to check for errors.\n                </p>\n              </div>')),e.success}).catch(()=>{bulmaJS.alert({message:"Error processing files.",contextualColorName:"danger"})}),m.classList.remove(...h)}),bulmaJS.init()})();